---
title: "Lectura EPF 2020"
author: "José Pernías"
date: "20/10/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Preliminares

Bibliotecas R:
```{r}
library(readr)
library(stringr)
library(purrr)
library(dplyr)
library(tidyr)
```
Carpeta de datos:
```{r}
data_dir <- file.path("..", "data")
```

Carpeta con los datos originales del INE:
```{r}
ine_data_dir <- file.path(data_dir, "INE", "datos_2020")
```

## Diccionario variables

```{r}
parse_vars <- function(fname, vars) {
  v <- vars %>% 
    str_trim(side = "right") %>%
    str_split("\n") %>% 
    pluck(1)
  m <- str_match(v, "^([A-Z0-9]+)[^T]+T([0-9]+),([A-Z0-9.]+)")
  tibble(file = str_to_lower(fname),
         var = m[, 2],
         start = m[, 3],
         code = m[, 4])
}

read_input_file <- function(path) {
  epf_inputs <- read_lines(path) %>%
    str_c(collapse = "\n") %>%
    str_match_all("FICHERO DE ([^*:]+)[^/]+/ ([\\s\\S]+?)EXECUTE") %>%
    pluck(1)
  
  colnames(epf_inputs) <- c("", "file", "vars")
  epf_df <- as_tibble(epf_inputs[, -1])
  
  epf_dict <- map2_dfr(epf_df$file, epf_df$vars, parse_vars) 

  width <- as.integer(str_match(epf_dict$code, "^.([0-9]+)")[, 2])
  dec <- as.integer(str_match(epf_dict$code, "\\.([0-9]+)$")[, 2])
  epf_dict %>%  mutate(width = width, 
                       dec = if_else(is.na(dec), 0L, dec),
                       type = if_else(str_starts(code, "A"), "c",
                                      if_else(dec > 0, "d", "i")))
}

input_file <- file.path(ine_data_dir, "Inputs SPSS 2020.txt")
epf_dict <- read_input_file(input_file)

```

## Lectura ficheros de datos

```{r}
read_epf_file <- function(fname) {
  dict <- epf_dict %>% filter(file == fname)
  
  df <- read_fwf(file.path(ine_data_dir, paste0(fname, ".bz2")), 
                 col_positions = fwf_widths(dict$width, dict$var),
                 col_types = paste0(dict$type, collapse = ""))

  ## Adjust variables with decimals
  dec_dict <- dict %>% 
    filter(dec != 0) %>%
    select(var, dec)

  for(i in seq_along(dec_dict$var)) {
    var <- dec_dict$var[i]
    dec <- dec_dict$dec[i]
    df[, var] <- df[, var] / 10^dec
  }
  
  df
}

hogar <- read_epf_file("hogar")
miembros <- read_epf_file("miembros")
gastos_orig <- read_epf_file("gastos")
```


```{r}
gastos_tipo <- gastos_orig %>%
  select(ANOENC, NUMERO, CODIGO, GASTMON, 
         GASTNOM1, GASTNOM2, GASTNOM3, GASTNOM4, GASTNOM5) %>%
  pivot_longer(-c(ANOENC, CODIGO, NUMERO), 
               names_to = "TIPO",
               values_to = "VALOR") %>%
  filter(!is.na(VALOR))

gastos <- gastos_orig %>% 
  select(-(GASTMON:GASTNOM5))
```


## Guarda ficheros de datos 

```{r}
save(hogar, file = file.path(data_dir, "hogar.Rdata"), compress = "xz")
save(miembros, file = file.path(data_dir, "miembros.Rdata"), compress = "xz")
save(gastos, file = file.path(data_dir, "gastos.Rdata"), compress = "xz")
save(gastos_tipo, file = file.path(data_dir, "gastos_tipo.Rdata"), compress = "xz")
```

